<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Krummhörn Data Wrangling</title>

<script src="library/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="library/bootstrap-3.3.5/css/paper.min.css" rel="stylesheet" />
<script src="library/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="library/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="library/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="library/navigation-1.1/tabsets.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>


<script src="library/auto_tab_first_section.js"></script>

</head>

<body>
<div style="width:100%;height:200px;background-image:url('library/header/krmh.jpg');background-size:cover;"></div>
<div class="container-fluid main-container"><div class="row"><div class="col-md-4"><a href="index.html"><i class="glyphicon glyphicon-th-list"></i> Back to index</a></div></div></div>

<div class="container-fluid main-container">


<div id="krummhorn-data-wrangling" class="section level1 tab-content">
<h1>Krummhörn Data wrangling</h1>
<div id="description-of-data" class="section level3">
<h3>description of data</h3>
<p>The Krummhörn area in Eastern Frisia had around 15000 inhabitants in the early modern period. This population size was comparatively stable, because the settling of this relatively fertile marsh land concluded early.</p>
<p>This dataset resulted from a continuous research effort that started at the Anthropological Institute at the University of Göttingen, moved to the University College London and is now at the Centre for Philosophy and Scientific Basics at the University of Gießen. The focus of the investigation lies at the intersection of genetic and cultural reproduction.</p>
<p>The data is based on the life histories contained in church registers. These were collected systematically and combined genealogically according to the method of family reconstitution. The main aim is the identification of persons and the reconstitution of their life histories. There are additional data on their social background, that could be gleaned from tax records and other social history sources.</p>
<p>The dataset was constructed according to the purposes of the biological inquiry, which results in the following aspects: Families that are mobile are only found in the file at one place, independent of the number of church communities that have records on them The basic unit of analyses is the core family. Their cycle begins typically with a wedding and ends in death or the children’s weddings.</p>
<p>The file is not final, it is continuously being corrected, amended and extended by including further church records.</p>
</div>
<div id="loading-details" class="section level3 accordion">
<h3>Loading details</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opts_chunk$<span class="kw">set</span>(<span class="dt">cache=</span>F,<span class="dt">tidy=</span><span class="ot">FALSE</span>,<span class="dt">autodep=</span><span class="ot">TRUE</span>,<span class="dt">dev=</span><span class="kw">c</span>(<span class="st">&#39;png&#39;</span>,<span class="st">&#39;pdf&#39;</span>),<span class="dt">fig.width=</span><span class="dv">12</span>,<span class="dt">fig.height=</span><span class="fl">7.5</span>,<span class="dt">out.width=</span><span class="st">&#39;1440px&#39;</span>,<span class="dt">out.height=</span><span class="st">&#39;900px&#39;</span>)
opts_knit$<span class="kw">set</span>(<span class="dt">self.contained=</span>F,<span class="dt">cache=</span>F)
<span class="kw">source</span>(<span class="st">&quot;0__helpers.R&quot;</span>)</code></pre></div>
</div>
<div id="transforming-data" class="section level2">
<h2>Transforming data</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.individuals =<span class="st"> </span><span class="kw">read.dta</span>(<span class="st">&quot;data/kh_24Nov2014/famkind3.dta&quot;</span>)
krmh.unions =<span class="st"> </span><span class="kw">read.dta</span>(<span class="st">&quot;data/kh_24Nov2014/KHfam-4.dta&quot;</span>)
krmh.individuals$idIndividu =<span class="st"> </span>krmh.individuals$idk
krmh.unions$idPere =<span class="st"> </span>krmh.unions$idm_new
krmh.unions$idMere =<span class="st"> </span>krmh.unions$idf_new
krmh.individuals =<span class="st"> </span><span class="kw">merge</span>(krmh.individuals, krmh.unions[, <span class="kw">c</span>(<span class="st">&#39;doc&#39;</span>,<span class="st">&#39;idPere&#39;</span>,<span class="st">&#39;idMere&#39;</span>)], <span class="dt">by =</span> <span class="st">&quot;doc&quot;</span>, <span class="dt">all.x=</span>T)

<span class="kw">table</span>(krmh.individuals$gebkk,<span class="dt">exclude=</span><span class="ot">NULL</span>)</code></pre></div>
<pre><code>## 
##           E     G     T  &lt;NA&gt; 
## 66699  6158  2015  5936     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(krmh.individuals$famstatus,<span class="dt">exclude=</span><span class="ot">NULL</span>)</code></pre></div>
<pre><code>## 
##     0     1     2     3     4     5  &lt;NA&gt; 
## 26563 24290  7503  9261  7255  5936     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.individuals =<span class="st"> </span><span class="kw">data.table</span>(krmh.individuals)
krmh.unions =<span class="st"> </span><span class="kw">data.table</span>(krmh.unions)


<span class="kw">miss_frac</span>(krmh.individuals)</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># make male var.</span>
<span class="kw">props</span>(~<span class="st"> </span>krmh.individuals$sex)</code></pre></div>
<pre><code>## krmh.individuals$sex
##       M       U       W 
## 0.50975 0.01077 0.47948</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.individuals[, male :<span class="er">=</span><span class="st"> </span><span class="kw">Recode</span>(sex,<span class="st">&quot;&#39;M&#39;=1;&#39;W&#39;=0;else=NA&quot;</span>)]
<span class="kw">props</span>(~<span class="st"> </span>krmh.individuals$male)</code></pre></div>
<pre><code>## krmh.individuals$male
##       0       1    &lt;NA&gt; 
## 0.47948 0.50975 0.01077</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># famstatus variables contains the following info</span>
<span class="co"># verheiratet: 1 (if famnrk empty)</span>
<span class="co"># ledig (aber ueber 15): 2 (wenn ueber 5 aber famnrk empty)</span>
<span class="co"># verstorben unter 15: 3</span>
<span class="co"># Totgeburt: 4</span>
<span class="kw">qplot</span>(krmh.individuals$famstatus)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/krmh.individuals-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">props</span>(~<span class="st"> </span>krmh.individuals$famstatus)</code></pre></div>
<pre><code>## krmh.individuals$famstatus
##       0       1       2       3       4       5 
## 0.32872 0.30059 0.09285 0.11460 0.08978 0.07346</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">props</span>(~<span class="st"> </span>krmh.individuals$gebkk)</code></pre></div>
<pre><code>## krmh.individuals$gebkk
##               E       G       T 
## 0.82540 0.07621 0.02494 0.07346</code></pre>
</div>
<div id="unions" class="section level2">
<h2>unions</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##### Get it into the form we&#39;re used to
<span class="kw">length</span>(<span class="kw">unique</span>(krmh.unions$doc)) <span class="co"># unique union identifier</span></code></pre></div>
<pre><code>## [1] 35075</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">### parent IDs

krmh.unions[, idParents :<span class="er">=</span><span class="st"> </span>doc]
<span class="kw">miss_frac</span>(krmh.unions)</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">intersect</span>(krmh.unions$idPere, krmh.individuals$idIndividu))</code></pre></div>
<pre><code>## [1] 12054</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">intersect</span>(krmh.unions$idMere, krmh.individuals$idIndividu))</code></pre></div>
<pre><code>## [1] 13559</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">intersect</span>(krmh.unions$idMere, krmh.unions$idPere))</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">length</span>(<span class="kw">intersect</span>(krmh.unions$doc, krmh.individuals$doc))</code></pre></div>
<pre><code>## [1] 28250</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.u =<span class="st"> </span><span class="kw">as.data.frame</span>(krmh.unions)
moms =<span class="st"> </span>krmh.u[!<span class="kw">is.na</span>(krmh.u$auswahl_id_f),<span class="kw">c</span>(<span class="st">&#39;idf_new&#39;</span>,<span class="kw">names</span>(krmh.u)[<span class="kw">names</span>(krmh.u) %ends_with%<span class="st"> &quot;_id_f&quot;</span>])]
dads =<span class="st"> </span>krmh.u[!<span class="kw">is.na</span>(krmh.u$auswahl_id_m),<span class="kw">c</span>(<span class="st">&#39;idm_new&#39;</span>,<span class="kw">names</span>(krmh.u)[<span class="kw">names</span>(krmh.u) %ends_with%<span class="st"> &quot;_id_m&quot;</span>])]
<span class="kw">names</span>(dads) =<span class="st"> </span><span class="kw">str_sub</span>(<span class="kw">names</span>(dads),<span class="dv">1</span>,-<span class="dv">6</span>)
<span class="kw">names</span>(moms) =<span class="st"> </span><span class="kw">str_sub</span>(<span class="kw">names</span>(moms),<span class="dv">1</span>,-<span class="dv">6</span>)
dads =<span class="st"> </span>dads[, <span class="kw">names</span>(moms)]
spouses =<span class="st"> </span><span class="kw">data.table</span>(<span class="kw">rbind</span>(dads,moms))</code></pre></div>
</div>
<div id="join-files" class="section level2">
<h2>join files</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.individuals[, ehemges :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">Recode</span>(ehemges,<span class="st">&quot;&#39; &#39;=1&quot;</span>))]
krmh.unions[, ehemges :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">Recode</span>(ehemges,<span class="st">&quot;&#39; &#39;=1&quot;</span>))]
krmh.individuals[, ehefges :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">Recode</span>(ehefges,<span class="st">&quot;&#39; &#39;=1&quot;</span>))]
krmh.unions[, ehefges :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">Recode</span>(ehefges,<span class="st">&quot;&#39; &#39;=1&quot;</span>))]

<span class="kw">qplot</span>(<span class="dt">data=</span><span class="kw">melt</span>(<span class="kw">numcolwise</span>(identity)(krmh.individuals)),value) +<span class="st"> </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>variable,<span class="dt">scales=</span><span class="st">&#39;free&#39;</span>)</code></pre></div>
<pre><code>## No id variables; using all as measure variables</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 1377919 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/krmh.joined-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># qplot(data=melt(catcolwise(identity)(krmh.individuals)),value) + facet_wrap(~ variable,scales=&#39;free&#39;)</span>
spouses[,idIndividu:<span class="er">=</span>id]
spouses$id=<span class="ot">NULL</span></code></pre></div>
<pre><code>## Warning in alloc.col(x): Attempt to reduce allocation from 111 to 110
## ignored. Can only increase allocation via shallow copy.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(<span class="dt">uniq_unions =</span> <span class="kw">setdiff</span>(<span class="kw">names</span>(spouses), <span class="kw">names</span>(krmh.individuals)))</code></pre></div>
<pre><code>##  [1] &quot;Nbirths&quot;        &quot;NinfantD&quot;       &quot;NchildD&quot;        &quot;NadultD&quot;       
##  [5] &quot;ageFfirstbirth&quot; &quot;ageFlastbirth&quot;  &quot;ageMfirstbirth&quot; &quot;ageMlastbirth&quot; 
##  [9] &quot;ageHfirst&quot;      &quot;ageHlast&quot;       &quot;auswahl&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span><span class="kw">merge</span>(krmh.individuals, spouses[, <span class="kw">list</span>(idIndividu, Nbirths, NinfantD, NchildD, NadultD, ageFfirstbirth, ageFlastbirth, ageMfirstbirth, ageMlastbirth, ageHfirst, ageHlast)], <span class="dt">by =</span> <span class="st">&quot;idIndividu&quot;</span>, <span class="dt">all.x =</span>T)
<span class="kw">table</span>(krmh$Nbirths)</code></pre></div>
<pre><code>## 
##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 
## 3248 2613 2512 2595 2535 2186 1695 1252  806  436  189  103   51   34   12 
##   16   17   18   20 
##   10    2    4    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">miss_frac</span>(krmh)</code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="count-kids" class="section level2">
<h2>count kids</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[,idParents :<span class="er">=</span><span class="st"> </span>doc]

count_spouses =<span class="st"> </span>function(df, df2, what,  wt_var) {
    df =<span class="st"> </span><span class="kw">data.frame</span>(df)
    df2 =<span class="st"> </span><span class="kw">data.frame</span>(df2)
    counted.husband =<span class="st"> </span><span class="kw">dcast</span>(<span class="dt">data=</span> df2[,<span class="kw">c</span>(<span class="st">&#39;idPere&#39;</span>,wt_var)],<span class="dt">formula =</span> idPere ~<span class="st"> </span>.,<span class="dt">fun.aggregate =</span> sum, <span class="dt">na.rm=</span>T, <span class="dt">value.var =</span> wt_var)
    counted.wive =<span class="st"> </span><span class="kw">dcast</span>(<span class="dt">data=</span> df2[,<span class="kw">c</span>(<span class="st">&#39;idMere&#39;</span>,wt_var)],<span class="dt">formula =</span> idMere ~<span class="st"> </span>.,<span class="dt">fun.aggregate =</span> sum, <span class="dt">na.rm=</span>T, <span class="dt">value.var =</span> wt_var)
    <span class="kw">names</span>(counted.husband) =<span class="st"> </span><span class="kw">names</span>(counted.wive) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;idIndividu&#39;</span>,what)
    counted =<span class="st"> </span><span class="kw">rbind</span>(counted.husband,counted.wive)
    df =<span class="st"> </span><span class="kw">merge</span>(df,counted,<span class="dt">by=</span><span class="st">&#39;idIndividu&#39;</span>,<span class="dt">all.x=</span>T)
    df[,what] =<span class="st"> </span><span class="kw">Recode</span>(df[,what],<span class="st">&#39;NA=0&#39;</span>)
    <span class="kw">data.table</span>(df)
}
krmh$born =<span class="st"> </span><span class="dv">1</span>; krmh.unions$born =<span class="st"> </span><span class="dv">1</span>
<span class="co"># spouses[spouses$idIndividu==1,]</span>
<span class="co"># krmh.unions[idPere==2,]</span>
<span class="co"># krmh.individuals[idIndividu==2,]</span>
krmh =<span class="st"> </span><span class="kw">count_spouses</span>(krmh,krmh.unions, <span class="st">&#39;spouses&#39;</span>, <span class="st">&quot;born&quot;</span>)

<span class="co"># qplot(krmh$spouses,ifelse(krmh$male==T, krmh$ehemges,krmh$ehefges), geom = &quot;jitter&quot;)</span>
<span class="co"># xtabs(~ krmh$spouses + ifelse(krmh$male==T, krmh$ehemges,krmh$ehefges), exclude =NULL, na.action=na.pass)</span>

krmh$survive1d =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageKtod_days &gt;<span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)
krmh$survive1m =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageKtod_days &gt;<span class="st"> </span><span class="dv">28</span>, <span class="dv">1</span>, <span class="dv">0</span>)
krmh$dead1m =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageKtod_days &gt;<span class="st"> </span><span class="dv">28</span>, <span class="dv">0</span>, <span class="dv">1</span>)
krmh$dead1y =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK1 &gt;=<span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)
krmh$dead5y =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK15 &gt;<span class="st"> </span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>)
krmh$deadR =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK15 &gt;=<span class="st"> </span><span class="dv">15</span>, <span class="dv">0</span>, <span class="dv">1</span>)
krmh$survive5y =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK15 &gt;<span class="st"> </span><span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">0</span>)
krmh$survive1y =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK1 &gt;=<span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)
krmh$surviveR =<span class="st"> </span><span class="kw">ifelse</span>(krmh$ageK15 &gt;=<span class="st"> </span><span class="dv">15</span>, <span class="dv">1</span>, <span class="dv">0</span>)


krmh$born =<span class="dv">1</span> 

krmh[, not_stillborn :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(famstatus !=<span class="st"> </span><span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">0</span>)]
krmh[, survive1d :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(famstatus !=<span class="st"> </span><span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">0</span>)] <span class="co"># small discrepancy of 7 with gebkk, but dead the first day, maybe not stillborn</span>
<span class="co"># krmh[, survive1d := ifelse(gebkk!=&#39;Todgeburt&#39; | is.na(gebkk),1, 0) ] # age is always missing in these ~1600 cases</span>
<span class="kw">props</span>(~<span class="st"> </span>krmh$survive1d)</code></pre></div>
<pre><code>## krmh$survive1d
##       0       1 
## 0.08978 0.91022</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xtabs</span>(<span class="dt">data=</span>krmh, ~<span class="st"> </span>spouses +<span class="st"> </span>famstatus)</code></pre></div>
<pre><code>##        famstatus
## spouses     0     1     2     3     4     5
##       0 26563     3  7503  9257  7255  4614
##       1     0 21407     0     4     0  1092
##       2     0  2613     0     0     0   198
##       3     0   247     0     0     0    27
##       4     0    19     0     0     0     5
##       5     0     1     0     0     0     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">props</span>(~<span class="st"> </span>krmh$famstatus)</code></pre></div>
<pre><code>## krmh$famstatus
##       0       1       2       3       4       5 
## 0.32872 0.30059 0.09285 0.11460 0.08978 0.07346</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[survive1d ==<span class="st"> </span><span class="dv">0</span>, age :<span class="er">=</span><span class="st"> </span><span class="dv">0</span> ] <span class="co"># i dont want age to be missing here</span>
krmh[survive1d ==<span class="st"> </span><span class="dv">0</span>, age.days :<span class="er">=</span><span class="st"> </span><span class="dv">0</span> ] <span class="co"># i dont want age to be missing here</span>

krmh[, ever_married :<span class="er">=</span><span class="st">  </span><span class="kw">ifelse</span>(famstatus==<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>) ] <span class="co"># famstatus does not map directly</span>
<span class="kw">xtabs</span>(<span class="dt">data=</span>krmh, ~<span class="st"> </span>spouses +<span class="st"> </span>ever_married) <span class="co"># big discrepancy</span></code></pre></div>
<pre><code>##        ever_married
## spouses     0     1
##       0 55192     3
##       1  1096 21407
##       2   198  2613
##       3    27   247
##       4     5    19
##       5     0     1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, ever_married :<span class="er">=</span><span class="st">  </span><span class="kw">ifelse</span>(spouses&gt;<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>) ]

<span class="kw">xtabs</span>(<span class="dt">data=</span>krmh, ~<span class="st"> </span>surviveR +<span class="st"> </span>ever_married)</code></pre></div>
<pre><code>##         ever_married
## surviveR     0     1
##        0 15454     0
##        1 14609 24798</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># krmh[ever_married == TRUE,surviveR := 1] # dead kids can&#39;t marry</span>

<span class="kw">props</span>(~<span class="st"> </span>krmh$surviveR)</code></pre></div>
<pre><code>## krmh$surviveR
##      0      1   &lt;NA&gt; 
## 0.1912 0.4877 0.3211</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(<span class="dt">data=</span>krmh, <span class="dt">x=</span> age) +<span class="st"> </span><span class="kw">facet_wrap</span> (~<span class="st"> </span>surviveR)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 73553 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/count.kids-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[,paternalage :<span class="er">=</span><span class="st"> </span>ageMgebK/<span class="dv">10</span>]
krmh[paternalage &lt;<span class="st"> </span><span class="dv">1</span> ,paternalage :<span class="er">=</span><span class="st"> </span><span class="ot">NA</span>]
krmh[,maternalage :<span class="er">=</span><span class="st"> </span>ageFgebK/<span class="dv">10</span>]

<span class="kw">qplot</span>(maternalage,paternalage,<span class="dt">data=</span>krmh,<span class="dt">geom=</span><span class="st">&quot;jitter&quot;</span>,<span class="dt">alpha=</span><span class="kw">I</span>(<span class="fl">0.1</span>))</code></pre></div>
<pre><code>## Warning: Removed 54034 rows containing missing values (geom_point).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/count.kids-2.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">cor.test</span>(krmh$maternalage,krmh$paternalage)</code></pre></div>
<pre><code>## 
##  Pearson&#39;s product-moment correlation
## 
## data:  krmh$maternalage and krmh$paternalage
## t = 130, df = 27000, p-value &lt;2e-16
## alternative hypothesis: true correlation is not equal to 0
## 95 percent confidence interval:
##  0.6185 0.6331
## sample estimates:
##    cor 
## 0.6259</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh.unions =<span class="st"> </span>krmh.unions[<span class="kw">order</span>(krmh.unions$idPere,krmh.unions$dat4),]
krmh.unions$marriage.order.Father =<span class="st"> </span><span class="kw">ave</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(krmh.unions)), krmh.unions$idPere, <span class="dt">FUN =</span> seq_along)
krmh.unions =<span class="st"> </span>krmh.unions[<span class="kw">order</span>(krmh.unions$idMere,krmh.unions$dat4),]
krmh.unions$marriage.order.Mother =<span class="st"> </span><span class="kw">ave</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(krmh.unions)), krmh.unions$idMere, <span class="dt">FUN =</span> seq_along)

krmh =<span class="st"> </span><span class="kw">merge</span>(krmh, krmh.unions[,<span class="kw">list</span>(idParents,marriage.order.Mother,marriage.order.Father,dat4,dat8),],<span class="dt">by=</span><span class="st">&quot;idParents&quot;</span>,<span class="dt">all.x=</span>T)
krmh$first.marriage =<span class="st"> </span>(krmh$marriage.order.Mother +<span class="st"> </span>krmh$marriage.order.Father) ==<span class="st"> </span><span class="dv">2</span>
<span class="kw">table</span>(krmh$first.marriage,<span class="dt">exclude=</span><span class="ot">NULL</span>)</code></pre></div>
<pre><code>## 
## FALSE  TRUE  &lt;NA&gt; 
##  9867 70941     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh.unions$marriage.order.Mother)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/count.kids-3.png" width="1440px" height="900px" /></p>
</div>
<div id="known-families" class="section level2">
<h2>Known families</h2>
<p>We apply the following criteria to consider a family “known”, which means we can make some further assumptions. If we know the bride’s and groom’s end of marriage, that is we have upper bound death dates (todk8) for at least one spouse and a lower bound death date for the other spouse that exceeds this date, we know that this family spent its time in the Krummhörn. Thus we can conclude that children who have missing death dates did not die, they emigrated (otherwise we’d have dates because the family is on-the-record).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># we consider a family &quot;known&quot; if we know that one spouse survived the other and we have the marriage date. if we have missing death dates for such children, we can assume that they emigrated (thus made 15), we&#39;d know if they&#39;d died in the KH</span>
krmh$known_family =<span class="st"> </span>krmh$ehebekannt
<span class="kw">nrow</span>(krmh[<span class="kw">is.na</span>(survive1m) &amp;<span class="st"> </span>known_family, ])</code></pre></div>
<pre><code>## [1] 18141</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(krmh[<span class="kw">is.na</span>(survive1y) &amp;<span class="st"> </span>known_family, ])</code></pre></div>
<pre><code>## [1] 2137</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">nrow</span>(krmh[<span class="kw">is.na</span>(surviveR) &amp;<span class="st"> </span>known_family, ])</code></pre></div>
<pre><code>## [1] 2137</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[<span class="kw">is.na</span>(survive1m) &amp;<span class="st"> </span>known_family, survive1m :<span class="er">=</span><span class="st"> </span><span class="dv">1</span> ]
krmh[<span class="kw">is.na</span>(survive1y) &amp;<span class="st"> </span>known_family, survive1y :<span class="er">=</span><span class="st"> </span><span class="dv">1</span> ]
krmh[<span class="kw">is.na</span>(surviveR) &amp;<span class="st"> </span>known_family, surviveR :<span class="er">=</span><span class="st"> </span><span class="dv">1</span> ]
<span class="kw">props</span>(~<span class="st"> </span>krmh$known_family)</code></pre></div>
<pre><code>## krmh$known_family
##     1  &lt;NA&gt; 
## 0.408 0.592</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&quot;born&quot;</span>)
<span class="kw">xtabs</span>(<span class="dt">data=</span>krmh, ~<span class="st"> </span>Nbirths +<span class="st"> </span>children,<span class="dt">na.action =</span> na.pass,<span class="dt">exclude=</span><span class="ot">NULL</span>)</code></pre></div>
<pre><code>##        children
## Nbirths     0     1     2     3     4     5     6     7     8     9    10
##    1        0  3248     0     0     0     0     0     0     0     0     0
##    2        0     0  2613     0     0     0     0     0     0     0     0
##    3        0     0     0  2512     0     0     0     0     0     0     0
##    4        0     0     0     0  2595     0     0     0     0     0     0
##    5        0     0     0     0     0  2535     0     0     0     0     0
##    6        0     0     0     0     0     0  2186     0     0     0     0
##    7        0     0     0     0     0     0     0  1695     0     0     0
##    8        0     0     0     0     0     0     0     0  1252     0     0
##    9        0     0     0     0     0     0     0     0     0   806     0
##    10       0     0     0     0     0     0     0     0     0     0   436
##    11       0     0     0     0     0     0     0     0     0     0     0
##    12       0     0     0     0     0     0     0     0     0     0     0
##    13       0     0     0     0     0     0     0     0     0     0     0
##    14       0     0     0     0     0     0     0     0     0     0     0
##    15       0     0     0     0     0     0     0     0     0     0     0
##    16       0     0     0     0     0     0     0     0     0     0     0
##    17       0     0     0     0     0     0     0     0     0     0     0
##    18       0     0     0     0     0     0     0     0     0     0     0
##    20       0     0     0     0     0     0     0     0     0     0     0
##    &lt;NA&gt; 60524     0     0     0     0     0     0     0     0     0     0
##        children
## Nbirths    11    12    13    14    15    16    17    18    20
##    1        0     0     0     0     0     0     0     0     0
##    2        0     0     0     0     0     0     0     0     0
##    3        0     0     0     0     0     0     0     0     0
##    4        0     0     0     0     0     0     0     0     0
##    5        0     0     0     0     0     0     0     0     0
##    6        0     0     0     0     0     0     0     0     0
##    7        0     0     0     0     0     0     0     0     0
##    8        0     0     0     0     0     0     0     0     0
##    9        0     0     0     0     0     0     0     0     0
##    10       0     0     0     0     0     0     0     0     0
##    11     189     0     0     0     0     0     0     0     0
##    12       0   103     0     0     0     0     0     0     0
##    13       0     0    51     0     0     0     0     0     0
##    14       0     0     0    34     0     0     0     0     0
##    15       0     0     0     0    12     0     0     0     0
##    16       0     0     0     0     0    10     0     0     0
##    17       0     0     0     0     0     0     2     0     0
##    18       0     0     0     0     0     0     0     4     0
##    20       0     0     0     0     0     0     0     0     1
##    &lt;NA&gt;     0     0     0     0     0     0     0     0     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$children.per.spouse =<span class="st"> </span>krmh$children/krmh$spouses
krmh$children.per.spouse[<span class="kw">which</span>(krmh$spouses==<span class="dv">0</span>)] =<span class="st"> </span><span class="ot">NA</span>
<span class="kw">qplot</span>(krmh$children.per.spouse)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 55195 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh$children)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-2.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># well we know that people who reproduced or married usually made 15</span>
changeNAto1 =<span class="st"> </span>function(x) { <span class="kw">colwise</span>(function(x) { <span class="kw">ifelse</span>(<span class="kw">is.na</span>(x), <span class="dv">1</span>, x)})(x) }
krmh[children&gt;<span class="dv">0</span> |<span class="st"> </span>spouses&gt;<span class="dv">0</span>, surviveR :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(surviveR), <span class="dv">1</span>, surviveR)]
krmh[children&gt;<span class="dv">0</span> |<span class="st"> </span>spouses&gt;<span class="dv">0</span>, survive1d :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(survive1d), <span class="dv">1</span>, survive1d)]
krmh[children&gt;<span class="dv">0</span> |<span class="st"> </span>spouses&gt;<span class="dv">0</span>, survive1y :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(survive1y), <span class="dv">1</span>, survive1y)]
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.surviving1d&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;survive1d&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.surviving1m&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;survive1m&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.surviving1y&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;survive1y&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.surviving5y&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;survive5y&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.survivingR&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;surviveR&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.dead1m&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;dead1m&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.dead1y&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;dead1y&#39;</span>)
<span class="kw">table</span>(krmh$children.dead1y==<span class="st"> </span>krmh$NinfantD)</code></pre></div>
<pre><code>## 
## FALSE  TRUE 
##   263 20021</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># xtabs(~ krmh$children.dead1y + krmh$NinfantD, exclude = NULL, na.action = na.pass)</span>
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.dead5y&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;dead5y&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.deadR&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;deadR&#39;</span>)
<span class="kw">table</span>(krmh$children.deadR -<span class="st"> </span>krmh$children.dead1y ==<span class="st"> </span>krmh$NchildD)</code></pre></div>
<pre><code>## 
##  TRUE 
## 20284</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xtabs</span>(~<span class="st"> </span><span class="kw">I</span>(krmh$children.deadR -<span class="st"> </span>krmh$children.dead1y) +<span class="st"> </span>krmh$NchildD, <span class="dt">exclude =</span> <span class="ot">NULL</span>, <span class="dt">na.action =</span> na.pass)</code></pre></div>
<pre><code>##                                              krmh$NchildD
## I(krmh$children.deadR - krmh$children.dead1y)     0     1     2     3
##                                             0 12880     0     0     0
##                                             1     0  5046     0     0
##                                             2     0     0  1634     0
##                                             3     0     0     0   536
##                                             4     0     0     0     0
##                                             5     0     0     0     0
##                                             6     0     0     0     0
##                                             7     0     0     0     0
##                                              krmh$NchildD
## I(krmh$children.deadR - krmh$children.dead1y)     4     5     6     7
##                                             0     0     0     0     0
##                                             1     0     0     0     0
##                                             2     0     0     0     0
##                                             3     0     0     0     0
##                                             4   148     0     0     0
##                                             5     0    33     0     0
##                                             6     0     0     3     0
##                                             7     0     0     0     4
##                                              krmh$NchildD
## I(krmh$children.deadR - krmh$children.dead1y)  &lt;NA&gt;
##                                             0 60524
##                                             1     0
##                                             2     0
##                                             3     0
##                                             4     0
##                                             5     0
##                                             6     0
##                                             7     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">changeNAto0 =<span class="st"> </span>function(x) { <span class="kw">ifelse</span>(<span class="kw">is.na</span>(x), <span class="dv">0</span>, x) }
krmh$children.unknown_fate =<span class="st"> </span>krmh$Nbirths -<span class="st"> </span>krmh$NchildD -<span class="st"> </span>krmh$NinfantD -<span class="st"> </span>krmh$NadultD
<span class="kw">qplot</span>(krmh$children.unknown_fate)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 60524 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-3.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(krmh$children.unknown_fate)</code></pre></div>
<pre><code>## 
##     0     1     2     3     4     5     6     7     8     9    10    11 
## 10534  3768  2204  1471  1075   608   330   186    49    37    12     6 
##    12    13    16 
##     2     1     1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(krmh$NchildD)</code></pre></div>
<pre><code>## 
##     0     1     2     3     4     5     6     7 
## 12880  5046  1634   536   148    33     3     4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;children.spouses&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;spouses&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.per.spouse&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.per.spouse&#39;</span>)

krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren&#39;</span>,<span class="dt">wt_var=</span><span class="st">&#39;children&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.surviving1d&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.surviving1d&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.surviving1m&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.surviving1m&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.surviving1y&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.surviving1y&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.survivingR&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.survivingR&#39;</span>)
krmh =<span class="st"> </span><span class="kw">count_and_merge</span>(krmh, <span class="st">&#39;grandchildren.dead1m&#39;</span>, <span class="dt">wt_var =</span> <span class="st">&#39;children.dead1m&#39;</span>)

<span class="kw">props</span>(~<span class="st"> </span>krmh$spouses)</code></pre></div>
<pre><code>## krmh$spouses
##         0         1         2         3         4         5 
## 6.830e-01 2.785e-01 3.479e-02 3.391e-03 2.970e-04 1.238e-05</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xtabs</span>(~<span class="st"> </span>(grandchildren&gt;<span class="dv">0</span>) +(children&gt;<span class="dv">0</span>) +<span class="st"> </span>(spouses&gt;<span class="dv">0</span>) +<span class="st"> </span>surviveR,<span class="dt">data=</span>krmh,<span class="dt">exclude=</span><span class="ot">NULL</span>, <span class="dt">na.action=</span> na.pass)</code></pre></div>
<pre><code>## , , spouses &gt; 0 = FALSE, surviveR = 0
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE 15454     0
##             TRUE      0     0
## 
## , , spouses &gt; 0 = TRUE, surviveR = 0
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE     0     0
##             TRUE      0     0
## 
## , , spouses &gt; 0 = FALSE, surviveR = 1
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE 16423     0
##             TRUE      0     0
## 
## , , spouses &gt; 0 = TRUE, surviveR = 1
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE  5329  9607
##             TRUE      0 10677
## 
## , , spouses &gt; 0 = FALSE, surviveR = NA
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE 23318     0
##             TRUE      0     0
## 
## , , spouses &gt; 0 = TRUE, surviveR = NA
## 
##                  children &gt; 0
## grandchildren &gt; 0 FALSE  TRUE
##             FALSE     0     0
##             TRUE      0     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh$children)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-4.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, age:<span class="er">=</span>ageKtod/<span class="dv">10</span>]
<span class="kw">qplot</span>(krmh[<span class="kw">which</span>(krmh$age &gt;<span class="st"> </span><span class="fl">1.5</span>),]$children )</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-5.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh$grandchildren)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-6.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh[<span class="kw">which</span>(krmh$age &gt;<span class="st"> </span><span class="fl">1.5</span>),]$grandchildren )</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-7.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh$spouses)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/known.families-8.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">miss_frac</span>(krmh)</code></pre></div>
<pre><code>## [1] 0</code></pre>
</div>
<div id="pre-calculate-some-predictors" class="section level2">
<h2>pre-calculate some predictors</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span>krmh[<span class="kw">order</span>(krmh$idParents,krmh$gebk4), ]
krmh &lt;-<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">birthorder =</span> <span class="kw">ave</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(krmh)), krmh$idParents, <span class="dt">FUN =</span> seq_along)) <span class="co"># old trick to get birth order, don&#39;t know what this does to those with missings for father though</span>
krmh$birthorder.mean =<span class="st"> </span><span class="kw">ave</span>(krmh$birthorder,krmh$idParents,<span class="dt">FUN=</span> function(x) { <span class="kw">mean</span>(x,<span class="dt">na.rm=</span>T) } )
krmh$birthorder.diff =<span class="st"> </span>krmh$birthorder -<span class="st"> </span>krmh$birthorder.mean
<span class="kw">qplot</span>(krmh$birthorder,<span class="dt">binwidth=</span><span class="dv">1</span>)</code></pre></div>
<p><img src="0_krmh_massage_files/figure-html/add.some.indicators-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, byear :<span class="er">=</span><span class="st"> </span><span class="kw">year</span>(gebk4)]

<span class="kw">transform</span>(krmh[<span class="dv">1</span>:<span class="dv">40</span>,<span class="kw">list</span>(idParents,byear,birthorder,surviveR)], <span class="dt">min15.birthorder =</span> <span class="kw">ave</span>(surviveR, idParents, <span class="dt">FUN =</span>function(x) { x[<span class="kw">is.na</span>(x)] =<span class="st"> </span><span class="dv">0</span>
<span class="kw">cumsum</span>(x)
} )) <span class="co"># NAs propagate problematically...</span>
krmh &lt;-<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">min15.birthorder =</span> <span class="kw">ave</span>(surviveR, idPere, <span class="dt">FUN =</span>function(x) { x[<span class="kw">is.na</span>(x)] =<span class="st"> </span><span class="dv">0</span>
<span class="kw">cumsum</span>(x)
} ))
<span class="kw">xtabs</span>(<span class="dt">data=</span>krmh, ~<span class="kw">is.na</span>(birthorder) +<span class="st"> </span><span class="kw">is.na</span>(min15.birthorder))</code></pre></div>
<pre><code>##                  is.na(min15.birthorder)
## is.na(birthorder) FALSE
##             FALSE 80808</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(krmh$min15.birthorder,<span class="dt">exclude=</span><span class="ot">NULL</span>)</code></pre></div>
<pre><code>## 
##     0     1     2     3     4     5     6     7     8     9    10    11 
## 23859 24089 12118  8134  5439  3341  1958  1037   484   200    77    41 
##    12    13    14  &lt;NA&gt; 
##    21     9     1     0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$min15.birthorder.mean =<span class="st"> </span><span class="kw">ave</span>(krmh$min15.birthorder,krmh$idParents,<span class="dt">FUN=</span> function(x) { <span class="kw">mean</span>(x,<span class="dt">na.rm=</span>T) } )
krmh$min15.birthorder.diff =<span class="st"> </span>krmh$min15.birthorder -<span class="st"> </span>krmh$min15.birthorder.mean

krmh[, nr.siblings :<span class="er">=</span><span class="st"> </span><span class="kw">ave</span>(born,doc,<span class="dt">FUN=</span> function(x) { <span class="kw">sum</span>(x,<span class="dt">na.rm=</span>T) } ) -<span class="st"> </span><span class="dv">1</span>] 
<span class="kw">qplot</span>(krmh$nr.siblings,<span class="dt">binwidth=</span><span class="dv">1</span>)</code></pre></div>
<p><img src="0_krmh_massage_files/figure-html/add.some.indicators-2.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$nr.dead.siblings1m =<span class="st"> </span><span class="kw">ave</span>(krmh$dead1m,krmh$idParents,<span class="dt">FUN=</span> function(x) { <span class="kw">sum</span>(x,<span class="dt">na.rm=</span>T) } ) -<span class="st"> </span>krmh$dead1m <span class="co"># don&#39;t count self! dont&#39;t control for outcome</span>
<span class="kw">qplot</span>(krmh$nr.dead.siblings1m,<span class="dt">binwidth=</span><span class="dv">1</span>)</code></pre></div>
<pre><code>## Warning: Removed 55835 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/add.some.indicators-3.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$infant.death.cluster =<span class="st"> </span>krmh$nr.dead.siblings1m/krmh$nr.siblings
<span class="kw">qplot</span>(krmh$infant.death.cluster)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 57229 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/add.some.indicators-4.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">qplot</span>(krmh[<span class="kw">which</span>(krmh$nr.siblings&gt;<span class="dv">1</span>),]$infant.death.cluster)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 38548 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/add.some.indicators-5.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lag<span class="fl">.0</span> =<span class="st"> </span>function(x) {   
    if(<span class="kw">length</span>(x)==<span class="dv">1</span>) <span class="dv">0</span>
    else <span class="kw">c</span>(<span class="dv">0</span>,x[ <span class="dv">1</span>:(<span class="kw">length</span>(x)-<span class="dv">1</span>)]) 
}
inv.lag<span class="fl">.0</span> =<span class="st"> </span>function(x) {   
    if(<span class="kw">length</span>(x)==<span class="dv">1</span>) <span class="dv">0</span>
    else <span class="kw">c</span>(x[ <span class="dv">2</span>:<span class="kw">length</span>(x)],<span class="dv">0</span>) 
}
krmh =<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">older.sib.made.15y =</span> <span class="kw">ave</span>(surviveR, idParents, <span class="dt">FUN =</span> lag<span class="fl">.0</span>))
krmh =<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">younger.sib.made.15y =</span> <span class="kw">ave</span>(surviveR, idParents, <span class="dt">FUN =</span> inv.lag<span class="fl">.0</span>))</code></pre></div>
</div>
<div id="get-grandparents" class="section level2">
<h2>Get grandparents</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">grandparents =<span class="st"> </span>krmh[, <span class="kw">list</span>(idIndividu,idPere,idMere, paternalage, maternalage)]
<span class="kw">names</span>(grandparents) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;idMere&#39;</span>, <span class="st">&#39;idMaternalGrandfather&#39;</span>, <span class="st">&#39;idMaternalGrandmother&#39;</span>, <span class="st">&#39;maternal.grandpaternalage&#39;</span>,  <span class="st">&#39;maternal.grandmaternalage&#39;</span>)
krmh =<span class="st"> </span><span class="kw">merge</span>(krmh, grandparents, <span class="dt">by =</span> <span class="st">&quot;idMere&quot;</span>, <span class="dt">all.x =</span>T)
<span class="kw">names</span>(grandparents) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;idPere&#39;</span>, <span class="st">&#39;idPaternalGrandfather&#39;</span>, <span class="st">&#39;idPaternalGrandmother&#39;</span>, <span class="st">&#39;paternal.grandpaternalage&#39;</span>,  <span class="st">&#39;paternal.grandmaternalage&#39;</span>)
krmh =<span class="st"> </span><span class="kw">merge</span>(krmh, grandparents, <span class="dt">by =</span> <span class="st">&quot;idPere&quot;</span>, <span class="dt">all.x =</span>T)</code></pre></div>
</div>
<div id="high-level-predictors" class="section level2">
<h2>high-level predictors</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$born =<span class="st"> </span><span class="ot">NULL</span> <span class="co"># was just an aid</span></code></pre></div>
<pre><code>## Warning in alloc.col(x): Attempt to reduce allocation from 299 to 298
## ignored. Can only increase allocation via shallow copy.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span><span class="kw">data.table</span>(krmh)
krmh[, bdate :<span class="er">=</span><span class="st"> </span>gebk4]
krmh[, ddate :<span class="er">=</span><span class="st"> </span>todk4]
krmh[, ddate.Mother :<span class="er">=</span><span class="st"> </span>todf4]
krmh[, ddate.Father :<span class="er">=</span><span class="st"> </span>todm4]
krmh$byear.years =<span class="st"> </span><span class="kw">year</span>(krmh$bdate)
krmh$dyear.years =<span class="st"> </span><span class="kw">year</span>(krmh$ddate)
krmh[, dyear :<span class="er">=</span><span class="st"> </span>dyear.years]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span>krmh %&gt;%
<span class="st">    </span>tbl_df %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(idParents) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(
        <span class="dt">younger_sibs_ad_5y =</span> <span class="kw">younger_sibs_alive_and_dependent</span>(<span class="dt">survive5y=</span>survive5y, <span class="dt">byear=</span>byear.years, <span class="dt">dyear=</span>dyear.years) ,
        <span class="dt">older_sibs_ad_5y =</span> <span class="kw">older_sibs_alive_and_dependent</span>(<span class="dt">survive5y=</span>survive5y, <span class="dt">byear=</span>byear.years, <span class="dt">dyear=</span>dyear.years),
        <span class="dt">dependent_sibs_f5y =</span> <span class="kw">dependent_sibs_f5y</span>(<span class="dt">survive1y=</span>survive1y, <span class="dt">byear=</span>byear, <span class="dt">dyear=</span>dyear)
    ) %&gt;%<span class="st"> </span><span class="kw">data.table</span>()</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">miss_frac</span>(krmh)</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$ddate =<span class="st"> </span><span class="kw">as.Date</span>(krmh$ddate)
krmh$ddate.Mother =<span class="st"> </span><span class="kw">as.Date</span>(krmh$ddate.Mother)
krmh$ddate.Father =<span class="st"> </span><span class="kw">as.Date</span>(krmh$ddate.Father)
krmh$bdate =<span class="st"> </span><span class="kw">as.Date</span>(krmh$bdate)
krmh$bdate.Mother =<span class="st"> </span><span class="kw">as.Date</span>(krmh$gebf4)
krmh$bdate.Father =<span class="st"> </span><span class="kw">as.Date</span>(krmh$gebm4)
krmh$paternal_alive =<span class="st"> </span><span class="kw">as.numeric</span>(krmh$ddate.Father-krmh$bdate)/<span class="dv">365</span>
<span class="kw">qplot</span>(krmh$paternal_alive)</code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 33293 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="0_krmh_massage_files/figure-html/parental.loss-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$paternalloss =<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">as.POSIXct</span>(krmh$bdate) +<span class="st"> </span><span class="kw">dyears</span>(<span class="dv">5</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$ddate.Father),<span class="dv">1</span>,<span class="dv">0</span>)
krmh$paternalloss_by_35 =<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$bdate) +<span class="st"> </span><span class="kw">dyears</span>(<span class="dv">35</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$ddate.Father)
krmh$maternalloss =<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">as.POSIXct</span>(krmh$bdate) +<span class="st"> </span><span class="kw">dyears</span>(<span class="dv">5</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$ddate.Mother),<span class="dv">1</span>,<span class="dv">0</span>)
krmh$maternalloss_by_35 =<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$bdate) +<span class="st"> </span><span class="kw">dyears</span>(<span class="dv">35</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(krmh$ddate.Mother)
krmh$parentalloss_might_be_disease =<span class="st"> </span><span class="ot">FALSE</span>
krmh[<span class="kw">as.POSIXct</span>(bdate) +<span class="st"> </span><span class="kw">ddays</span>(<span class="dv">30</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(ddate.Father),]$parentalloss_might_be_disease =<span class="st"> </span><span class="ot">TRUE</span>
krmh[<span class="kw">as.POSIXct</span>(bdate) +<span class="st"> </span><span class="kw">ddays</span>(<span class="dv">30</span>) &gt;<span class="st"> </span><span class="kw">as.POSIXct</span>(ddate.Mother),]$parentalloss_might_be_disease =<span class="st"> </span><span class="ot">TRUE</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh =<span class="st"> </span><span class="kw">data.table</span>(krmh) 
krmh$landownership =<span class="st"> </span><span class="kw">Recode</span>(krmh$grasen,<span class="st">&quot;0:1=&#39;0 landless&#39;;1:25=&#39;1-25 grasen&#39;;25:140=&#39;25-140 grasen&#39;;140:hi=&#39;140+ grasen&#39;&quot;</span>)
krmh$landless =<span class="st"> </span><span class="kw">Recode</span>(krmh$grasen,<span class="st">&quot;0:1=T;1:hi=F&quot;</span>)
<span class="kw">props</span>(~<span class="st"> </span>krmh$landownership)</code></pre></div>
<pre><code>## krmh$landownership
##    0 landless   1-25 grasen   140+ grasen 25-140 grasen          &lt;NA&gt; 
##       0.14782       0.06791       0.01771       0.06346       0.70310</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">props</span>(~<span class="st"> </span>krmh$landless) </code></pre></div>
<pre><code>## krmh$landless
##      0      1   &lt;NA&gt; 
## 0.1491 0.1478 0.7031</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, ageK5 :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(age &gt;<span class="st"> </span><span class="dv">5</span>, <span class="dv">5</span>, age)]
krmh[krmh$dat8_fam1&lt;<span class="st"> </span>krmh$bdate, dat8_fam1:<span class="er">=</span><span class="ot">NA</span>]
krmh[, paternalloss_m :<span class="er">=</span><span class="st"> </span>(<span class="kw">ifelse</span>(bdate +<span class="st"> </span><span class="kw">days</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(ageK5), <span class="dv">5</span>, <span class="kw">round</span>(ageK5*<span class="dv">365</span>))) &lt;=<span class="st"> </span>ddate.Father,
                                                                    <span class="kw">ifelse</span>(<span class="kw">is.na</span>(dat8_fam1) |<span class="st"> </span>ddate.Father &lt;<span class="st"> </span>dat8_fam1, <span class="st">&#39;dead_b_m&#39;</span>, <span class="st">&#39;dead_a_m&#39;</span>), <span class="st">&#39;dead_5y&#39;</span>))]
krmh[, maternalloss_m :<span class="er">=</span><span class="st"> </span>(<span class="kw">ifelse</span>(bdate +<span class="st"> </span><span class="kw">days</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(ageK5), <span class="dv">5</span>, <span class="kw">round</span>(ageK5*<span class="dv">365</span>))) &lt;=<span class="st"> </span>ddate.Mother,
                                                                    <span class="kw">ifelse</span>(<span class="kw">is.na</span>(dat8_fam1) |<span class="st"> </span>ddate.Mother &lt;<span class="st"> </span>dat8_fam1, <span class="st">&#39;dead_b_m&#39;</span>, <span class="st">&#39;dead_a_m&#39;</span>), <span class="st">&#39;dead_5y&#39;</span>))]
krmh[, paternalloss_k1 :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(bdate +<span class="st"> </span><span class="kw">days</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(ageK1), <span class="dv">1</span>, <span class="kw">round</span>(ageK1*<span class="dv">365</span>))) &lt;=<span class="st"> </span>ddate.Father,
                                                                    <span class="dv">1</span>,<span class="dv">0</span>)]
krmh[, maternalloss_k1 :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(
    bdate +<span class="st"> </span><span class="kw">days</span>(<span class="kw">ifelse</span>(<span class="kw">is.na</span>(ageK1), <span class="co"># if the birth date is larger </span>
            <span class="kw">ifelse</span>(<span class="kw">is.na</span>(survive1y),<span class="dv">1</span>,<span class="dv">365</span>), <span class="kw">round</span>(ageK1*<span class="dv">365</span>))) &lt;=<span class="st"> </span>ddate.Mother,
                                                                    <span class="dv">1</span>,<span class="dv">0</span>)]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, mother_child_die_within_7d :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">abs</span>(ddate -<span class="st"> </span>ddate.Mother) &lt;=<span class="st"> </span><span class="dv">7</span>, <span class="dv">1</span>, <span class="dv">0</span>)]
krmh[<span class="kw">is.na</span>(mother_child_die_within_7d), mother_child_die_within_7d :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(nr.siblings &gt;<span class="st"> </span>birthorder, <span class="dv">0</span>, <span class="ot">NA</span>)]
krmh[<span class="kw">is.na</span>(mother_child_die_within_7d), mother_child_die_within_7d :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(survive1y==<span class="dv">1</span>, <span class="dv">0</span>, <span class="ot">NA</span>)]
<span class="kw">crosstabs</span>(krmh$mother_child_die_within_7d)</code></pre></div>
<pre><code>## krmh$mother_child_die_within_7d
##     0     1  &lt;NA&gt; 
## 65490   625 14693</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, maternalloss_k1 :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>( ageK1 &lt;<span class="st"> </span><span class="dv">1</span>, 
            <span class="kw">ifelse</span>(ddate.Mother &lt;<span class="st"> </span>ddate,
            <span class="kw">ifelse</span>( mother_child_die_within_7d, 
                    <span class="st">&quot;disease_double_death&quot;</span>, <span class="st">&quot;mother_died_before_child&quot;</span>),
                    <span class="st">&quot;no_early_maternal_loss&quot;</span>),
                    <span class="kw">ifelse</span>(<span class="kw">as.POSIXct</span>(ddate.Mother) &lt;<span class="st"> </span><span class="kw">as.POSIXct</span>(bdate) +<span class="st"> </span><span class="kw">dyears</span>(<span class="dv">1</span>), 
                        <span class="st">&quot;mother_died_before_child&quot;</span>, <span class="st">&quot;no_early_maternal_loss&quot;</span>)
        )]</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">crosstabs</span>(krmh$maternalloss_k1)</code></pre></div>
<pre><code>## krmh$maternalloss_k1
##     disease_double_death mother_died_before_child   no_early_maternal_loss 
##                       42                      839                    38671 
##                     &lt;NA&gt; 
##                    41256</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, early_maternalloss :<span class="er">=</span><span class="st"> </span>maternalloss_k1 !=<span class="st"> &quot;no_early_maternal_loss&quot;</span> ]
krmh[, maternalloss_k1 :<span class="er">=</span><span class="st"> </span><span class="kw">relevel</span>(<span class="kw">factor</span>(maternalloss_k1), <span class="dt">ref =</span> <span class="st">&quot;no_early_maternal_loss&quot;</span>)]

<span class="kw">crosstabs</span>(~krmh$paternalloss_m) </code></pre></div>
<pre><code>## krmh$paternalloss_m
##  dead_5y dead_a_m dead_b_m     &lt;NA&gt; 
##      813     7715    38987    33293</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">crosstabs</span>(~krmh$maternalloss_m)</code></pre></div>
<pre><code>## krmh$maternalloss_m
##  dead_5y dead_a_m dead_b_m     &lt;NA&gt; 
##      702     9396    37027    33683</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">crosstabs</span>(~krmh$maternalloss_m +<span class="st"> </span>krmh$paternalloss_m) </code></pre></div>
<pre><code>##                    krmh$paternalloss_m
## krmh$maternalloss_m dead_5y dead_a_m dead_b_m  &lt;NA&gt;
##            dead_5y       31      105      399   167
##            dead_a_m     162     4845     3502   887
##            dead_b_m     426     2084    28917  5600
##            &lt;NA&gt;         194      681     6169 26639</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">min_na =<span class="st"> </span>function(x) { <span class="kw">ifelse</span>(<span class="kw">all</span>(<span class="kw">is.na</span>(x)), <span class="ot">NA</span>, <span class="kw">min</span>(x, <span class="dt">na.rm=</span>T) ) }
max_na =<span class="st"> </span>function(x) { <span class="kw">ifelse</span>(<span class="kw">all</span>(<span class="kw">is.na</span>(x)), <span class="ot">NA</span>, <span class="kw">max</span>(x, <span class="dt">na.rm=</span>T) ) }
krmh[, paternalage_at_1st_sib :<span class="er">=</span><span class="st"> </span><span class="kw">ave</span>(paternalage, idPere, <span class="dt">FUN =</span> min_na)]
krmh[, paternalage_at_last_sib :<span class="er">=</span><span class="st"> </span><span class="kw">ave</span>(paternalage, idPere, <span class="dt">FUN =</span> max_na)]
krmh[, maternalage_at_1st_sib :<span class="er">=</span><span class="st"> </span><span class="kw">ave</span>(maternalage, idMere, <span class="dt">FUN =</span> min_na)]
krmh[, maternalage_at_last_sib :<span class="er">=</span><span class="st"> </span><span class="kw">ave</span>(maternalage, idMere, <span class="dt">FUN =</span> max_na)]
fathers =<span class="st"> </span>krmh[!<span class="kw">duplicated</span>(idPere), <span class="kw">list</span>(idPere, paternalage_at_1st_sib, paternalage_at_last_sib)]
<span class="kw">names</span>(fathers) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;idIndividu&quot;</span>,<span class="st">&quot;age_at_1st_child&quot;</span>, <span class="st">&quot;age_at_last_child&quot;</span>)
mothers =<span class="st"> </span>krmh[!<span class="kw">duplicated</span>(idMere), <span class="kw">list</span>(idMere, maternalage_at_1st_sib, maternalage_at_last_sib)]
<span class="kw">names</span>(mothers) =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;idIndividu&quot;</span>,<span class="st">&quot;age_at_1st_child&quot;</span>, <span class="st">&quot;age_at_last_child&quot;</span>)
parents =<span class="st"> </span><span class="kw">rbind</span>(fathers, mothers) 
krmh =<span class="st"> </span><span class="kw">merge</span>(krmh, parents, <span class="dt">by =</span> <span class="st">&quot;idIndividu&quot;</span>, <span class="dt">all.x =</span> T)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$dyear.Mother =<span class="st"> </span><span class="kw">year</span>(krmh$ddate.Mother)
krmh$dyear.Father =<span class="st"> </span><span class="kw">year</span>(krmh$ddate.Father)
krmh %&gt;%<span class="st">  </span>
<span class="kw">mutate</span>(<span class="dt">maternal_loss_age =</span> dyear.Mother -<span class="st"> </span>byear
                 ,<span class="dt">maternal_loss_age =</span> <span class="kw">as.numeric</span>(<span class="kw">ifelse</span>(maternal_loss_age &gt;=<span class="st"> </span>-<span class="dv">1</span> &amp;<span class="st"> </span>maternal_loss_age &lt;<span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, maternal_loss_age))
                 ,<span class="dt">maternal_loss  =</span> <span class="kw">as.character</span>(<span class="kw">cut</span>(maternal_loss_age, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">25</span>,<span class="dv">30</span>,<span class="dv">35</span>,<span class="dv">40</span>,<span class="dv">45</span>), <span class="dt">include.lowest =</span> T ))
                 ,<span class="dt">maternal_loss =</span> <span class="kw">ifelse</span>( maternal_loss_age &gt;=<span class="st"> </span><span class="dv">45</span>, <span class="st">&quot;later&quot;</span>, maternal_loss)
                 ,<span class="dt">maternal_loss =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(maternal_loss_age) |<span class="st"> </span>maternal_loss_age &lt;<span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;unclear&quot;</span>, maternal_loss)
                 ,<span class="dt">maternal_loss =</span> <span class="kw">factor</span>(maternal_loss, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;later&quot;</span>,<span class="st">&quot;[0,1]&quot;</span>, <span class="st">&quot;(1,5]&quot;</span>, <span class="st">&quot;(5,10]&quot;</span>, <span class="st">&quot;(10,15]&quot;</span>, <span class="st">&quot;(15,20]&quot;</span>, <span class="st">&quot;(20,25]&quot;</span>, <span class="st">&quot;(25,30]&quot;</span>, <span class="st">&quot;(30,35]&quot;</span>,  <span class="st">&quot;(35,40]&quot;</span>, <span class="st">&quot;(40,45]&quot;</span>, <span class="st">&quot;unclear&quot;</span>))
                 
                 ,<span class="dt">paternal_loss_age =</span> dyear.Father -<span class="st"> </span>byear
                 ,<span class="dt">paternal_loss_age =</span> <span class="kw">as.numeric</span>(<span class="kw">ifelse</span>(paternal_loss_age &gt;=<span class="st"> </span>-<span class="dv">1</span> &amp;<span class="st"> </span>paternal_loss_age &lt;<span class="st"> </span><span class="dv">0</span>, <span class="dv">0</span>, paternal_loss_age))
                 ,<span class="dt">paternal_loss  =</span> <span class="kw">as.character</span>(<span class="kw">cut</span>(paternal_loss_age, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">20</span>,<span class="dv">25</span>,<span class="dv">30</span>,<span class="dv">35</span>,<span class="dv">40</span>,<span class="dv">45</span>), <span class="dt">include.lowest =</span> T ))
                 ,<span class="dt">paternal_loss =</span> <span class="kw">ifelse</span>( paternal_loss_age &gt;=<span class="st"> </span><span class="dv">45</span>, <span class="st">&quot;later&quot;</span>, paternal_loss)
                 ,<span class="dt">paternal_loss =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(paternal_loss_age) |<span class="st"> </span>paternal_loss_age &lt;<span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;unclear&quot;</span>, paternal_loss)
                 ,<span class="dt">paternal_loss =</span> <span class="kw">factor</span>(paternal_loss, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;later&quot;</span>,<span class="st">&quot;[0,1]&quot;</span>, <span class="st">&quot;(1,5]&quot;</span>,  <span class="st">&quot;(5,10]&quot;</span>, <span class="st">&quot;(10,15]&quot;</span>, <span class="st">&quot;(15,20]&quot;</span>, <span class="st">&quot;(20,25]&quot;</span>, <span class="st">&quot;(25,30]&quot;</span>, <span class="st">&quot;(30,35]&quot;</span>,  <span class="st">&quot;(35,40]&quot;</span>, <span class="st">&quot;(40,45]&quot;</span>, <span class="st">&quot;unclear&quot;</span>))
                 ) %&gt;%
<span class="st">    </span><span class="kw">data.table</span>() -&gt;
<span class="st">    </span>krmh
<span class="kw">table</span>(krmh$maternal_loss, <span class="dt">exclude =</span> <span class="ot">NULL</span>) </code></pre></div>
<pre><code>## 
##   later   [0,1]   (1,5]  (5,10] (10,15] (15,20] (20,25] (25,30] (30,35] 
##    8567    1822    3297    4023    3853    3675    3919    4374    4768 
## (35,40] (40,45] unclear    &lt;NA&gt; 
##    5079    3739   33692       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(krmh$paternal_loss, <span class="dt">exclude =</span> <span class="ot">NULL</span>)</code></pre></div>
<pre><code>## 
##   later   [0,1]   (1,5]  (5,10] (10,15] (15,20] (20,25] (25,30] (30,35] 
##    5230    1448    3332    4638    4937    5164    5238    5302    5006 
## (35,40] (40,45] unclear    &lt;NA&gt; 
##    4353    2854   33306       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[, birth.cohort :<span class="er">=</span><span class="st"> </span><span class="kw">year_bins</span>(byear)]
<span class="kw">crosstabs</span>(krmh$birth.cohort) </code></pre></div>
<pre><code>## krmh$birth.cohort
## 1570-1575 1580-1585 1585-1590 1595-1600 1600-1605 1605-1610 1615-1620 
##         2         1         1         1         1         2         3 
## 1620-1625 1625-1630 1630-1635 1635-1640 1640-1645 1645-1650 1650-1655 
##         2         5        44        78       100        95        97 
## 1655-1660 1660-1665 1665-1670 1670-1675 1675-1680 1680-1685 1685-1690 
##       169       155       194       254       254       285       339 
## 1690-1695 1695-1700 1700-1705 1705-1710 1710-1715 1715-1720 1720-1725 
##       378       717       800       826       945      1189      1121 
## 1725-1730 1730-1735 1735-1740 1740-1745 1745-1750 1750-1755 1755-1760 
##      1319      1850      2001      1955      1859      1783      1945 
## 1760-1765 1765-1770 1770-1775 1775-1780 1780-1785 1785-1790 1790-1795 
##      1916      2182      2210      2047      1920      1882      2069 
## 1795-1800 1800-1805 1805-1810 1810-1815 1815-1820 1820-1825 1825-1830 
##      2217      2161      2045      2145      2310      2374      2369 
## 1830-1835 1835-1840 1840-1845 1845-1850 1850-1855 1855-1860 1860-1865 
##      2336      2389      2488      2467      2380      2284      2236 
## 1865-1870 1870-1875 1875-1880 1880-1885 1885-1890 1890-1895 1895-1900 
##      2325      2175       526       475       494       458       510 
## 1900-1905 1905-1910 1910-1915 1915-1920 1920-1925 1925-1930 1930-1935 
##       400       276       119        36        17         7         3 
##      &lt;NA&gt; 
##      5790</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh[byear &lt;<span class="st"> </span><span class="dv">1670</span>, birth.cohort :<span class="er">=</span><span class="st"> &quot;1570-1670&quot;</span>]
krmh[byear &gt;=<span class="st"> </span><span class="dv">1670</span> &amp;<span class="st"> </span>byear &lt;<span class="st"> </span><span class="dv">1700</span>, birth.cohort :<span class="er">=</span><span class="st"> &quot;1670-1700&quot;</span>]
krmh[byear &gt;=<span class="st"> </span><span class="dv">1700</span> &amp;<span class="st"> </span>byear &lt;<span class="st"> </span><span class="dv">1720</span>, birth.cohort :<span class="er">=</span><span class="st"> &quot;1700-1720&quot;</span>]
krmh[byear &gt;=<span class="st"> </span><span class="dv">1720</span> &amp;<span class="st"> </span>byear &lt;<span class="st"> </span><span class="dv">1760</span>, birth.cohort :<span class="er">=</span><span class="st"> &quot;1720-1760&quot;</span>]
krmh[byear &gt;=<span class="st"> </span><span class="dv">1900</span>, birth.cohort :<span class="er">=</span><span class="st"> &quot;1900-1935&quot;</span>] 
<span class="kw">crosstabs</span>(krmh$birth.cohort) </code></pre></div>
<pre><code>## krmh$birth.cohort
## 1570-1670 1670-1700 1700-1720 1720-1760 1760-1765 1765-1770 1770-1775 
##       950      2227      3760     13833      1916      2182      2210 
## 1775-1780 1780-1785 1785-1790 1790-1795 1795-1800 1800-1805 1805-1810 
##      2047      1920      1882      2069      2217      2161      2045 
## 1810-1815 1815-1820 1820-1825 1825-1830 1830-1835 1835-1840 1840-1845 
##      2145      2310      2374      2369      2336      2389      2488 
## 1845-1850 1850-1855 1855-1860 1860-1865 1865-1870 1870-1875 1875-1880 
##      2467      2380      2284      2236      2325      2175       526 
## 1880-1885 1885-1890 1890-1895 1895-1900 1900-1935      &lt;NA&gt; 
##       475       494       458       510       858      5790</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$older_siblings =<span class="st"> </span><span class="kw">factor</span>(<span class="kw">ifelse</span>((krmh$birthorder -<span class="st"> </span><span class="dv">1</span>) &gt;<span class="st"> </span><span class="dv">4</span>,<span class="st">&quot;5+&quot;</span>, krmh$birthorder -<span class="st"> </span><span class="dv">1</span>))
krmh$last_born =<span class="st"> </span><span class="kw">ifelse</span>(krmh$birthorder ==<span class="st"> </span>krmh$nr.siblings, <span class="dv">1</span>, <span class="dv">0</span>)

krmh =<span class="st"> </span>krmh[<span class="kw">order</span>(krmh$idParents,krmh$bdate), ] 
krmh &lt;-<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">siblings =</span> <span class="kw">ave</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(krmh)), krmh$idParents, <span class="dt">FUN =</span> length)-<span class="dv">1</span>) <span class="co"># sibling count</span>
krmh &lt;-<span class="st"> </span><span class="kw">transform</span>(krmh, <span class="dt">birthorder =</span> <span class="kw">ave</span>(<span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(krmh)), krmh$idParents, <span class="dt">FUN =</span> seq_along)) <span class="co"># old trick to get birth order, don&#39;t know what this does to those with missings for father though</span>
<span class="kw">qplot</span>(krmh$birthorder) </code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="0_krmh_massage_files/figure-html/sibcounts-1.png" width="1440px" height="900px" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">krmh$younger_siblings =<span class="st"> </span>krmh$siblings +<span class="st"> </span><span class="dv">1</span> -<span class="st"> </span>krmh$birthorder</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">recenter_all =<span class="st"> </span>function(x) { <span class="kw">recenter.pat</span>( <span class="kw">recenter.pat</span>( x, <span class="dt">among_who=</span><span class="st">&quot;idParents&quot;</span>), <span class="dt">what =</span> <span class="st">&quot;maternalage&quot;</span>, <span class="dt">among_who =</span> <span class="st">&quot;idParents&quot;</span>) }

krmh[fall %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;P&quot;</span>,<span class="st">&quot;C&quot;</span>) &amp;<span class="st"> </span>ehem==<span class="st">&quot; &quot;</span>, ehem :<span class="er">=</span><span class="st"> &quot;1&quot;</span>]

krmh$birth_cohort =<span class="st"> </span><span class="kw">factor</span>(krmh$birth.cohort)
krmh$male =<span class="st"> </span><span class="kw">factor</span>(krmh$male)
krmh$last_born =<span class="st"> </span><span class="kw">factor</span>(krmh$last_born) 

krmh =<span class="st"> </span><span class="kw">recenter_all</span>(krmh)
krmh[, any_surviving_children :<span class="er">=</span><span class="st"> </span><span class="kw">ifelse</span>(children.survivingR &gt;<span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)]
krmh[, children.wddate :<span class="er">=</span><span class="st"> </span>children.dead1y +<span class="st"> </span>children.surviving1y] 
krmh =<span class="st"> </span>krmh[, maternalage.factor :<span class="er">=</span><span class="st"> </span><span class="kw">cut</span>((<span class="dv">10</span>*maternalage), <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">14</span>, <span class="dv">20</span>, <span class="dv">35</span>, <span class="dv">50</span>))]
krmh$maternalage.factor =<span class="st"> </span><span class="kw">relevel</span>(krmh$maternalage.factor, <span class="dt">ref =</span> <span class="st">&quot;(20,35]&quot;</span>)
krmh.with.paternalage =<span class="st"> </span><span class="kw">subset</span>(krmh, <span class="dt">subset =</span> !<span class="kw">is.na</span>(paternalage) )
krmh.fm =<span class="st"> </span><span class="kw">subset</span>(krmh.with.paternalage, <span class="dt">subset =</span> ehebekannt==<span class="ot">TRUE</span> &amp;<span class="st"> </span>paternal_loss !=<span class="st"> &quot;unclear&quot;</span> &amp;<span class="st"> </span>maternal_loss !=<span class="st"> &quot;unclear&quot;</span>) <span class="co"># krmh.fm contains only those were we know how the marriage ended</span>

krmh<span class="fl">.1</span> =<span class="st"> </span>krmh.fm[geburtsjahrK&gt;=<span class="dv">1720</span> &amp;<span class="st"> </span>geburtsjahrK&lt;<span class="st"> </span><span class="dv">1835</span>, ]
<span class="kw">save</span>(krmh,krmh<span class="fl">.1</span>,<span class="dt">file=</span><span class="st">&quot;krmh.rdata&quot;</span>) 
<span class="co"># save(krmh,krmh.1,krmh_pedigree,file=&quot;krmh.rdata&quot;)</span></code></pre></div>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>
</body>
</html>
